#!/bin/bash

usage() {
    echo "Usage:"
    echo "  podman-ollama [OPTION...] [PROMPT]"
    echo
    echo "Options:"
    echo "  -c,--container-manager CONMAN - Specify podman or docker, default: podman"
    echo "  -g,--gpu GPU                  - Specify a GPU, valid values are AMD and OTHER"
    echo "  -h,--help                     - Usage help"
    echo "  -m,--model MODEL              - Specify non-default model, default: $LLM"
    echo "  -r,--root                     - Run as a rootful, insecure container"
    echo "  -                             - Read from stdin"
    echo
}

cleanup() {
  $SUDO $CON exec $CON_PS pkill ollama &
}

check_root() {
  if [ "$EUID" -eq 0 ]; then
    if ! $ROOT; then
      echo "to run as a rootful, insecure container, use this command as root user:"
      echo "  podman-ollama -r"
      exit 3
    fi
  elif $ROOT; then
    echo "to run as a rootful, insecure container, use this command as root user:"
    echo "  podman-ollama -r"
    exit 4
  fi
}

server_init() {
  check_root
  specify_gpu
  select_container_manager
  trap cleanup EXIT

  if [ -e "/dev/dri" ]; then
    ADD="--device /dev/dri"
  fi

  if [ "$GPU" = "OTHER" ]; then
    POST="latest"
  elif [ "$GPU" = "AMD" ] || [ -e "/dev/kfd" ]; then
    ADD="$ADD --device /dev/kfd"
    POST="rocm"
  else
    POST="latest"
  fi

  VOL="ollama:/root/.ollama"
  URL="docker.io/ollama/ollama:$POST"
  PRIV="--privileged"
  GPU="--gpus=all"
  CON_PS=$($SUDO $CON run --rm $PRIV -d $ADD $GPU -v"$HOME":"$HOME" -v$VOL $URL)
  RET="$?"
  if [ "$RET" -ne 0 ]; then
    echo "$CON_PS"
    exit $RET
  fi
}

select_container_manager() {
  if command -v podman > /dev/null; then
    CON="podman"
  elif command -v docker > /dev/null; then
    CON="docker"
  else
    CON="podman"
  fi

  if [ -n "$CONMAN" ]; then
    shopt -s nocasematch
    case "$CONMAN" in
      podman ) CON="podman";;
      docker) CON="docker";;
      *) echo "Unknown container manager: $CONMAN"; exit 2;;
    esac

    shopt -u nocasematch
  fi
}

specify_gpu() {
  if [ -n "$GPU" ]; then
    shopt -s nocasematch
    case "$GPU" in
      OTHER ) GPU="OTHER";;
      AMD) GPU="AMD";;
      *) echo "Unknown GPU: $GPU"; exit 2;;
    esac

    shopt -u nocasematch
  fi
}

set_initial_vars() {
  LLM="mistral"
  STDIN="false"
  ROOT="false"
}

set -e -o pipefail

set_initial_vars
while [[ $# -gt 0 ]]; do
  case $1 in
    -c|--container-manager)
      CONMAN="$2"
      shift 2
      ;;
    -g|--gpu)
      GPU="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    -m|--model)
      LLM="$2"
      shift 2
      ;;
    -r|--root)
      ROOT="true"
      shift 1
      ;;
    -)
      STDIN="true"
      shift 1
      ;;
    -*|--*)
      usage
      echo "Unknown option $1"
      exit 1
      ;;
    *)
      break;
      ;;
  esac
done

server_init

if $STDIN; then
  $SUDO $CON exec $CON_PS ollama run $LLM "$(cat /dev/stdin)"
elif [ -n "$1" ]; then
  $SUDO $CON exec $CON_PS ollama run $LLM "$1"
else
  $SUDO $CON exec -it $CON_PS ollama run $LLM
fi

