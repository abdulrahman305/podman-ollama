#!/bin/bash

cleanup() {
  $PRE $CON exec -it $CON_PS pkill ollama
}

set -e -o pipefail

if command -v podman > /dev/null; then
  CON="podman"
elif command -v docker > /dev/null; then
  CON="docker"
else
  CON="podman"
fi

if [ -e "/dev/dri" ]; then
  ADD="--device /dev/dri"
fi

if [ -e "/dev/kfd" ]; then
  ADD="$ADD --device /dev/kfd"
  POST="rocm"
else
  POST="latest"
fi

CON_URL="docker.io/ollama/ollama:$POST"

trap cleanup EXIT

CON_PS=$($PRE $CON run --rm -d $ADD --gpus=all -v ollama:/root/.ollama $CON_URL)
if [ -n "$1" ]; then
  $PRE $CON exec -it $CON_PS ollama run llama2 "$1"
else
  $PRE $CON exec -it $CON_PS ollama run llama2
fi

